name: Desktop Releases (macOS)

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Version tag (e.g., 3.4.5)'
        required: true
        type: string
      mark_prerelease:
        description: "Mark as prerelease"
        required: true
        default: false
        type: boolean
      sign_and_notarize:
        description: "Sign and notarize (requires secrets)"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: write

concurrency:
  group: desktop-release-macos-${{ inputs.version_tag }}
  cancel-in-progress: false

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  build-macos:
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: macos-15-intel
          - arch: arm64
            runner: macos-latest
    runs-on: ${{ matrix.runner }}
    env:
      APP_VERSION: ${{ inputs.version_tag }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ inputs.version_tag }}

      - uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: gradle

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust JNI (host)
        run: cargo build --release --manifest-path rust/Cargo.toml

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build and prepare native libraries
        run: |
          ./gradlew :shared:cargoBuildDesktop :shared:copyNativeForJna :shared:genUniFFIJvm

      - name: Package desktop application
        run: |
          ./gradlew :desktopApp:packageDmg --no-daemon

      - name: Import signing certificate
        if: ${{ inputs.sign_and_notarize }}
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.MACOS_CERTIFICATE_P12 }}
          p12-password: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}

      - name: Sign application
        if: ${{ inputs.sign_and_notarize }}
        run: |
          APP_PATH=$(find desktopApp/build/compose/binaries/main/app -name "*.app" | head -n 1)
          if [ -n "$APP_PATH" ]; then
            codesign --deep --force --verify --verbose \
              --sign "${{ secrets.MACOS_SIGNING_IDENTITY }}" \
              --options runtime \
              "$APP_PATH"
          fi

      - name: Create DMG
        run: |
          mkdir -p dist
          APP_PATH=$(find desktopApp/build/compose/binaries/main/app -name "*.app" | head -n 1)
          if [ -n "$APP_PATH" ]; then
            APP_NAME=$(basename "$APP_PATH" .app)
            DMG_NAME="${APP_NAME}-${{ inputs.version_tag }}-${{ matrix.arch }}.dmg"
            
            mkdir -p dmg-contents
            cp -R "$APP_PATH" dmg-contents/
            ln -s /Applications dmg-contents/Applications
            
            hdiutil create -volname "$APP_NAME" \
              -srcfolder dmg-contents \
              -ov -format UDZO \
              "dist/$DMG_NAME"
            
            rm -rf dmg-contents
          fi

      - name: Notarize DMG
        if: ${{ inputs.sign_and_notarize }}
        run: |
          DMG_FILE=$(find dist -name "*.dmg" | head -n 1)
          if [ -n "$DMG_FILE" ]; then
            xcrun notarytool submit "$DMG_FILE" \
              --apple-id "${{ secrets.MACOS_NOTARIZATION_APPLE_ID }}" \
              --password "${{ secrets.MACOS_NOTARIZATION_PASSWORD }}" \
              --team-id "${{ secrets.MACOS_NOTARIZATION_TEAM_ID }}" \
              --wait
            
            xcrun stapler staple "$DMG_FILE"
          fi

      - name: Collect artifacts
        run: |
          mkdir -p dist
          find desktopApp/build/compose/binaries/main -type f -name "*.pkg" | while read pkg; do
            base=$(basename "$pkg" .pkg)
            cp "$pkg" "dist/${base}-${{ inputs.version_tag }}-${{ matrix.arch }}.pkg"
          done
          ls -la dist

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-desktop-${{ matrix.arch }}
          path: dist/*

  release:
    needs: build-macos
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: macos-desktop-*
          merge-multiple: true
          path: dist

      - name: List artifacts
        run: ls -la dist/

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version_tag }}
          name: ${{ inputs.version_tag }}
          prerelease: ${{ inputs.mark_prerelease }}
          files: dist/*
