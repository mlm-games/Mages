name: Publish to Snapcraft

on:
  workflow_dispatch:
    inputs:
      version_name:
        description: 'Version name (e.g., 0.2.7)'
        required: true

concurrency:
  group: snap-${{ inputs.version_name }}
  cancel-in-progress: false

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Preflight | Check release tag
        run: |
          curl -fsSL "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ inputs.version_name }}" >/dev/null

      - name: Preflight | Check secret
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}
        run: |
          [ -n "$SNAPCRAFT_STORE_CREDENTIALS" ] || { echo "Missing secret SNAPCRAFT_TOKEN" >&2; exit 1; }

      - name: Fetch Linux binary
        run: |
          mkdir -p packaging/snap/builds
          mkdir -p packaging/snap/snap/gui
          cp packaging/io.github.mlm_games.mages.desktop packaging/snap/snap/gui/mages.desktop
          cp fastlane/metadata/android/en-US/images/icon-256.png packaging/snap/snap/gui/icon.png
          
          set -e
          echo "Fetch 'mages-${{ inputs.version_name }}-x86_64.AppImage'..."
          curl -fL "https://github.com/${{ github.repository }}/releases/download/${{ inputs.version_name }}/mages-${{ inputs.version_name }}-x86_64.AppImage" -o packaging/snap/builds/mages.AppImage
          chmod +x packaging/snap/builds/mages.AppImage

      - name: Update version in snapcraft.yml
        run: |
          sed -i "s/^version: .*/version: '${{ inputs.version_name }}'/" packaging/snap/snapcraft.yaml
          sed -i "s|VERSION_PLACEHOLDER|${{ inputs.version_name }}|g" packaging/snap/snapcraft.yaml
          echo "packaging/snap/snapcraft.yaml version updated"
          cat packaging/snap/snapcraft.yaml | grep -E "^version:|source:"

      - name: Build snap
        uses: snapcore/action-build@v1
        id: build
        with:
          path: packaging/snap

      - name: Publish to Snap Store
        uses: snapcore/action-publish@v1
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_TOKEN }}
        with:
          snap: ${{ steps.build.outputs.snap }}
          release: stable
