name: Create Vendored Sources Tarball

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Version tag (e.g., 3.4.5)'
        required: true
        type: string
      mark_prerelease:
        description: "Mark as prerelease"
        required: true
        default: false
        type: boolean
  release:
    types: [published]

jobs:
  create-vendored-tarball:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version_tag }}"
          else
            VERSION="${{ github.event.release.tag_name }}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Vendor Rust dependencies
        run: |
          set -e
          
          mkdir -p .cargo vendor
          
          echo " Vendor main project"
          cd rust
          cargo vendor --versioned-dirs ../vendor 2>&1 | tee /tmp/vendor-main.txt
          cd ..
          
          echo "Main vendor: $(ls vendor | wc -l) packages"
          
          echo ""
          echo " Vendor uniffi-bindgen"
          mkdir -p /tmp/vendor-uniffi
          cd rust/uniffi-bindgen
          cargo vendor --versioned-dirs /tmp/vendor-uniffi 2>&1 | tee /tmp/vendor-uniffi.txt
          cd ../..
          
          echo ""
          echo " Merge uniffi deps"
          cp -r /tmp/vendor-uniffi/* vendor/ 2>/dev/null || true
          
          echo "Merged vendor: $(ls vendor | wc -l) packages"
          
          echo ""
          echo " Create config.toml"
          sed -n '/^To use vendored sources/,$p' /tmp/vendor-main.txt | tail -n +3 > .cargo/config.toml
          sed -i 's|directory = "../vendor"|directory = "vendor"|g' .cargo/config.toml
          
          cat .cargo/config.toml

      - name: Vendor Gradle Dependencies (ALL platforms)
        run: |
          set -e
          
          mkdir -p gradle-deps
          export GRADLE_USER_HOME=$(pwd)/gradle-deps
          
          echo " Building for current platform"
          ./gradlew :desktopApp:createDistributable --no-daemon
          
          echo " Downloading linux-arm64 compose deps"
          
          # Create a temp project to fetch ARM64 deps
          mkdir -p /tmp/fetch-project
          cat > /tmp/fetch-project/settings.gradle.kts << 'EOF'
          rootProject.name = "fetch-deps"
          EOF
          
          cat > /tmp/fetch-project/build.gradle.kts << 'EOF'
          plugins {
              id("java")
          }
          
          repositories {
              mavenCentral()
              google()
              maven("https://maven.pkg.jetbrains.space/public/p/compose/dev")
          }
          
          val composeArm64 by configurations.creating
          val composeX64 by configurations.creating
          
          dependencies {
              composeArm64("org.jetbrains.compose.desktop:desktop-jvm-linux-arm64:1.11.0-alpha02")
              composeX64("org.jetbrains.compose.desktop:desktop-jvm-linux-x64:1.11.0-alpha02")
          }
          
          tasks.register("fetch") {
              doLast {
                  configurations["composeArm64"].resolve()
                  configurations["composeX64"].resolve()
                  println("Downloaded all platform deps")
              }
          }
          EOF
          
          cd /tmp/fetch-project
          gradle --no-daemon fetch
          cd -
          
          echo " Cleaning up"
          ./gradlew clean --no-daemon
          rm -rf rust/target desktopApp/build shared/build
          
          find gradle-deps -name "*.lock" -delete
          rm -rf gradle-deps/daemon gradle-deps/.tmp gradle-deps/kotlin-profile
          
          echo " Gradle cache size"
          du -sh gradle-deps

      - name: Create Fat Tarball
        run: |
          TARBALL_NAME="mages-${VERSION}-vendored-sources.tar.gz"
          mkdir -p package/mages
          
          git archive --format=tar HEAD | tar -C package/mages -xf -
          cp -r vendor package/mages/
          cp -r .cargo package/mages/
          cp -r gradle-deps package/mages/
          
          cd package
          tar -czf "../${TARBALL_NAME}" mages/
          cd ..
          
          sha256sum "${TARBALL_NAME}" > "${TARBALL_NAME}.sha256"
          echo "SHA256: $(cat ${TARBALL_NAME}.sha256)"

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version_tag }}
          name: ${{ inputs.version_tag }}
          prerelease: ${{ inputs.mark_prerelease }}
          files: |
            mages-${{ inputs.version_tag }}-vendored-sources.tar.gz
            mages-${{ inputs.version_tag }}-vendored-sources.tar.gz.sha256
