name: Create Vendored Sources Tarball

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., 2.3.6)'
        required: true
  release:
    types: [published]

jobs:
  create-vendored-tarball:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: recursive
          ref: ${{ github.event_name == 'release' && github.event.release.tag_name || github.event.inputs.version }}

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.event.release.tag_name }}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Vendor Rust dependencies
        run: |
          mkdir -p .cargo
          # Configure cargo to vendor to a local directory
          cargo vendor --versioned-dirs vendor > .cargo/config.toml

      - name: Vendor Gradle Dependencies
        run: |
          # Create a local directory for Gradle cache
          mkdir -p gradle-deps
          
          export GRADLE_USER_HOME=$(pwd)/gradle-deps
          
          echo "Downloading Gradle distribution and dependencies..."
          ./gradlew :desktopApp:assemble --no-daemon --info
          
          echo "Cleaning up build artifacts..."
          ./gradlew clean --no-daemon
          rm -rf desktopApp/build shared/build rust/target
          
          echo "Sanitizing Gradle Cache..."
          find gradle-deps -name "*.lock" -delete
          find gradle-deps -name "*.bin" -delete
          rm -rf gradle-deps/daemon
          rm -rf gradle-deps/kotlin-profile

      - name: Create Fat Tarball
        run: |
          TARBALL_NAME="mages-${VERSION}-vendored-sources.tar.gz"
          
          # Create a clean directory for packaging
          mkdir -p package/mages
          
          # Copy source code (excluding git history)
          git archive --format=tar HEAD | tar -C package/mages -xf -
          
          # Copy the vendored dependencies we just created
          cp -r vendor package/mages/
          cp -r .cargo package/mages/
          cp -r gradle-deps package/mages/
          
          cd package
          tar -czf "../${TARBALL_NAME}" mages/
          cd ..
          
          sha256sum "${TARBALL_NAME}" > "${TARBALL_NAME}.sha256"
          
          echo "SHA256: $(cat ${TARBALL_NAME}.sha256)"

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version_tag }}
          name: ${{ inputs.version_tag }}
          files: |
            mages-${{ env.VERSION }}-vendored-sources.tar.gz
            mages-${{ env.VERSION }}-vendored-sources.tar.gz.sha256