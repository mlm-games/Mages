name: Desktop Releases (Windows)

on:
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Version tag (e.g., 3.4.5)'
        required: true
        type: string
      mark_prerelease:
        description: "Mark as prerelease"
        required: true
        default: false
        type: boolean

permissions:
  contents: write
  actions: write

concurrency:
  group: desktop-release-windows-${{ inputs.version_tag }}
  cancel-in-progress: false

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  build-windows:
    # native ARM64 runners are not yet available on Gh
    runs-on: windows-latest
    env:
      APP_VERSION: ${{ inputs.version_tag }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ inputs.version_tag }}

      - uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: gradle

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust JNI (host)
        run: cargo build --release --manifest-path rust/Cargo.toml

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build and prepare native libraries
        run: |
          ./gradlew :shared:cargoBuildDesktop :shared:copyNativeForJna :shared:genUniFFIJvm

      - name: Package desktop application
        run: |
          ./gradlew :desktopApp:packageMsi --no-daemon

      - name: Collect desktop artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist
          Get-ChildItem -Path desktopApp/build/compose/binaries/main -Recurse -Include *.msi,*.exe | ForEach-Object {
            $newName = "$($_.BaseName)-${{ inputs.version_tag }}-x64$($_.Extension)"
            Copy-Item -Path $_.FullName -Destination "dist/$newName"
          }
          Get-ChildItem dist

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-desktop-x64
          path: dist/*

  release:
    needs: build-windows
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: windows-desktop-*
          merge-multiple: true
          path: dist

      - name: List artifacts
        run: ls -la dist/

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.version_tag }}
          name: ${{ inputs.version_tag }}
          prerelease: ${{ inputs.mark_prerelease }}
          files: dist/*
